#!/source/this/sh

export_ () { export $1=$2 ; }

export_ MYBORG          $(cat ~/.local/var/myborg/current.txt)
export_ MYBORG_SBIN     ${MYBORG}/bin
export_ MYBORG_MANIFEST ${MYBORG}/MANIFEST
export_ MYBORG_DOTS     ${MYBORG}/dots
export_ MYBORG_BUILD        ${MYBORG}/.build
export_ MYBORG_MODS         ${MYBORG_BUILD}/mods
export_ MYBORG_VENDOR       ${MYBORG_BUILD}/vendor
export_ MYBORG_LBIN         ${MYBORG_BUILD}/lbin
export_ MYBORG_OPT          ${HOME}/.local/opt/MYBORG_OPT

export_ PATH ${PATH}:${HOME}/.local/bin
export_ PATH ${PATH}:${MYBORG_SBIN}
export_ PATH ${PATH}:${MYBORG_LBIN}

mkdir -p   ${MYBORG_BUILD}
rm -f      ${MYBORG_LBIN}/*
rmdir      ${MYBORG_LBIN}
mkdir -p   ${MYBORG_LBIN}

# This function is used by clients.
__lbin_default () { cp ../lbin/* ${MYBORG_LBIN} ; }


main () {
    echo "++[$MYBORG/main] $*"
    echo processing VENDOR     ; ${MYBORG}/VENDOR
    echo processing MANIFEST   ; ${MYBORG}/MANIFEST
    echo activating mods...    ; __myborg_activate
    echo borgifying...         ; __myborg_borgify $1
    echo "++[$MYBORG/main] $*"
}

__myborg_source () {
    [ "$1" = "-q" ] || __myborg_note__ sourcing $*
    [ "$1" = "-q" ] && shift
    source $*
}
__myborg_borgify () {
    [ ! "$1" == "" ] && {
        __myborg_source borg:__first__
        __myborg_source ${MYBORG_DOTS}/dot$1
        __myborg_source borg:__last__
        __myborg_source borg:path:clean
    }
}
__myborg_activate () {
    for path in $(borg.ls.fullpath ${MYBORG_MODS}); do
        [ ! -f ${path}/.insitu/activate ] && printf "[skip] \t[${path}]\n"
        [ ! -f ${path}/.insitu/activate ] && continue
        printf "[ ok ] \t[${path}]\n"
        > /dev/null   pushd $path/.insitu
        . ./activate
        > /dev/null   popd
    done
}


__myborg_note__ () {
    printf "$1:\t" ; shift ; printf "[$*]" ; echo
}
main $*
